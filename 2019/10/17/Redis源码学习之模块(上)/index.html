<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Redis,æºç ,">










<meta name="description" content="WhatRedis Moduleç³»ç»Ÿæ˜¯Redis4å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼ˆå¾ˆæƒ­æ„§çš„æ˜¯ç°åœ¨æ‰çŸ¥é“ï¼Œä¸€ç›´ä»¥ä¸ºæ˜¯Redis5å¼•è¿›çš„æ–°ç‰¹æ€§ğŸ˜¢ï¼‰ã€‚é€šè¿‡Redis Moduleå¯ä»¥æ‰©å±•Redisæœ¬èº«çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå®ç°ä¸€äº›Redisæœ¬èº«ä¸æ”¯æŒçš„å‘½ä»¤ã€‚ è™½ç„¶Rediså·²ç»æä¾›äº†Luaè„šæœ¬çš„ç¼–ç¨‹èƒ½åŠ›æ¥æ‰©å±•Redisçš„èƒ½åŠ›ï¼Œä½†æ˜¯Luaè„šæœ¬åªèƒ½ç»„åˆç°æœ‰çš„æ•°æ®ç»“æ„å’Œå‘½ä»¤ï¼Œæ²¡æ³•åˆ›å»ºæ–°çš„å‘½ä»¤ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedisæ¨¡å—è¿˜å…·æœ‰ä»¥ä¸‹å‡ ä¸ª">
<meta name="keywords" content="Redis,æºç ">
<meta property="og:type" content="article">
<meta property="og:title" content="Redisæ¨¡å—å­¦ä¹ (ä¸Š):What And How">
<meta property="og:url" content="http://yoursite.com/2019/10/17/Redisæºç å­¦ä¹ ä¹‹æ¨¡å—(ä¸Š)/index.html">
<meta property="og:site_name" content="å¤©å‡‰å¥½ä¸ªç§‹">
<meta property="og:description" content="WhatRedis Moduleç³»ç»Ÿæ˜¯Redis4å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼ˆå¾ˆæƒ­æ„§çš„æ˜¯ç°åœ¨æ‰çŸ¥é“ï¼Œä¸€ç›´ä»¥ä¸ºæ˜¯Redis5å¼•è¿›çš„æ–°ç‰¹æ€§ğŸ˜¢ï¼‰ã€‚é€šè¿‡Redis Moduleå¯ä»¥æ‰©å±•Redisæœ¬èº«çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå®ç°ä¸€äº›Redisæœ¬èº«ä¸æ”¯æŒçš„å‘½ä»¤ã€‚ è™½ç„¶Rediså·²ç»æä¾›äº†Luaè„šæœ¬çš„ç¼–ç¨‹èƒ½åŠ›æ¥æ‰©å±•Redisçš„èƒ½åŠ›ï¼Œä½†æ˜¯Luaè„šæœ¬åªèƒ½ç»„åˆç°æœ‰çš„æ•°æ®ç»“æ„å’Œå‘½ä»¤ï¼Œæ²¡æ³•åˆ›å»ºæ–°çš„å‘½ä»¤ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedisæ¨¡å—è¿˜å…·æœ‰ä»¥ä¸‹å‡ ä¸ª">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-10-20T14:05:19.141Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redisæ¨¡å—å­¦ä¹ (ä¸Š):What And How">
<meta name="twitter:description" content="WhatRedis Moduleç³»ç»Ÿæ˜¯Redis4å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼ˆå¾ˆæƒ­æ„§çš„æ˜¯ç°åœ¨æ‰çŸ¥é“ï¼Œä¸€ç›´ä»¥ä¸ºæ˜¯Redis5å¼•è¿›çš„æ–°ç‰¹æ€§ğŸ˜¢ï¼‰ã€‚é€šè¿‡Redis Moduleå¯ä»¥æ‰©å±•Redisæœ¬èº«çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå®ç°ä¸€äº›Redisæœ¬èº«ä¸æ”¯æŒçš„å‘½ä»¤ã€‚ è™½ç„¶Rediså·²ç»æä¾›äº†Luaè„šæœ¬çš„ç¼–ç¨‹èƒ½åŠ›æ¥æ‰©å±•Redisçš„èƒ½åŠ›ï¼Œä½†æ˜¯Luaè„šæœ¬åªèƒ½ç»„åˆç°æœ‰çš„æ•°æ®ç»“æ„å’Œå‘½ä»¤ï¼Œæ²¡æ³•åˆ›å»ºæ–°çš„å‘½ä»¤ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedisæ¨¡å—è¿˜å…·æœ‰ä»¥ä¸‹å‡ ä¸ª">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/10/17/Redisæºç å­¦ä¹ ä¹‹æ¨¡å—(ä¸Š)/">





  <title>Redisæ¨¡å—å­¦ä¹ (ä¸Š):What And How | å¤©å‡‰å¥½ä¸ªç§‹</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">å¤©å‡‰å¥½ä¸ªç§‹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/17/Redisæºç å­¦ä¹ ä¹‹æ¨¡å—(ä¸Š)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Slogen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="å¤©å‡‰å¥½ä¸ªç§‹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Redisæ¨¡å—å­¦ä¹ (ä¸Š):What And How</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-10-17T20:22:31+08:00">
                2019-10-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/17/Redisæºç å­¦ä¹ ä¹‹æ¨¡å—(ä¸Š)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/10/17/Redisæºç å­¦ä¹ ä¹‹æ¨¡å—(ä¸Š)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p>Redis Moduleç³»ç»Ÿæ˜¯Redis4å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼ˆå¾ˆæƒ­æ„§çš„æ˜¯ç°åœ¨æ‰çŸ¥é“ï¼Œä¸€ç›´ä»¥ä¸ºæ˜¯Redis5å¼•è¿›çš„æ–°ç‰¹æ€§ğŸ˜¢ï¼‰ã€‚é€šè¿‡Redis Moduleå¯ä»¥æ‰©å±•Redisæœ¬èº«çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå®ç°ä¸€äº›Redisæœ¬èº«ä¸æ”¯æŒçš„å‘½ä»¤ã€‚</p>
<p>è™½ç„¶Rediså·²ç»æä¾›äº†Luaè„šæœ¬çš„ç¼–ç¨‹èƒ½åŠ›æ¥æ‰©å±•Redisçš„èƒ½åŠ›ï¼Œä½†æ˜¯Luaè„šæœ¬åªèƒ½ç»„åˆç°æœ‰çš„æ•°æ®ç»“æ„å’Œå‘½ä»¤ï¼Œæ²¡æ³•åˆ›å»ºæ–°çš„å‘½ä»¤ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedisæ¨¡å—è¿˜å…·æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š</p>
<ol>
<li>ä½œä¸ºä¸€ä¸ªCè¯­è¨€å¼€å‘çš„åº“ï¼ŒRedis Moduleæ¶ˆè€—æ›´å°‘çš„èµ„æºï¼Œè¿è¡Œçš„æ›´å¿«ã€‚è€Œä¸”åœ¨å¼€å‘Redisæ¨¡å—çš„è¿‡ç¨‹ä¸­è¿˜å¯ä»¥è°ƒç”¨ç¬¬ä¸‰æ–¹çš„åº“ã€‚</li>
<li>Redisæ¨¡å—å®ç°çš„å‘½ä»¤å¯ä»¥ç›´æ¥è¢«å®¢æˆ·ç«¯è°ƒç”¨ï¼Œå°±å¥½åƒRedisåŸç”Ÿçš„å‘½ä»¤ä¸€æ ·ã€‚è€ŒLuaè„šæœ¬åªèƒ½é€šè¿‡EVAL/EVALSHAå‘½ä»¤è¿›è¡Œè°ƒç”¨ã€‚</li>
<li>æš´éœ²ç»™Redisæ¨¡å—çš„APIæ¯”Luaè„šæœ¬çš„è¦ä¸°å¯Œçš„å¤šã€‚</li>
</ol>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><h4 id="åŠ è½½æ¨¡å—"><a href="#åŠ è½½æ¨¡å—" class="headerlink" title="åŠ è½½æ¨¡å—"></a>åŠ è½½æ¨¡å—</h4><p>Redisæ¨¡å—å¯ä»¥é€šè¿‡åœ¨Redisçš„é…ç½®æ–‡ä»¶<code>redis.conf</code>ä¸­æ·»åŠ ä¸‹é¢æŒ‡ä»¤æ¥åŠ è½½ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadmodule /path/to/module.so</span><br></pre></td></tr></table></figure></p>
<p>ä¹Ÿå¯ä»¥åœ¨Rediså·²ç»å¯åŠ¨ä¹‹åçš„è¿è¡Œæ—¶é€šè¿‡<code>module</code>å‘½ä»¤æ¥åŠ è½½æ¨¡å—ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MODULE LOAD /path/to/module.so</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; module list</span><br><span class="line">(empty list or set)</span><br><span class="line">127.0.0.1:6379&gt; module load /Users/Slogen/Documents/code/slogen/module/module.o</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; module list</span><br><span class="line">1) 1) &quot;name&quot;</span><br><span class="line">   2) &quot;list_extend&quot;</span><br><span class="line">   3) &quot;ver&quot;</span><br><span class="line">   4) (integer) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨<code>MODULE LIST</code>å‘½ä»¤æ¥åˆ—å‡ºå·²ç»åŠ è½½çš„æ¨¡å—ã€‚</p>
<p>ä½¿ç”¨<code>MODULE UNLOAD</code>å‘½ä»¤æ¥å¸è½½å·²ç»åŠ è½½çš„æ¨¡å—:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; module unload list_extend</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; module list</span><br><span class="line">(empty list or set)</span><br></pre></td></tr></table></figure></p>
<p>Redisæ¨¡å—APIåœ¨è®¾è®¡ä¹‹åˆå°±è€ƒè™‘åˆ°äº†å°†æ¥ï¼ˆå¯èƒ½å‡ºç°çš„ï¼‰å…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥æ— è®ºRedisæ ¸å¿ƒå‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼Œä½ ç°åœ¨å¼€å‘çš„Redisæ¨¡å—ï¼Œåªè¦APIä¸å˜ï¼Œ4å¹´åä»ç„¶èƒ½è¿è¡Œã€‚åŸºäºè¿™äº›åŸºæœ¬åŸç†ï¼Œè®¾è®¡äº†ä¸¤ç§ä¸åŒçš„APIæ¥è®¿é—®Redisçš„æ•°æ®ç©ºé—´ã€‚</p>
<ul>
<li>ç¬¬ä¸€ç§æ˜¯ä¸€äº›ä½çº§APIã€‚è¿™äº›APIæä¾›äº†ä¸€ç³»åˆ—æ“ä½œå¯ä»¥æ›´å¿«é€Ÿçš„è®¿é—®ä»¥åŠæ“ä½œRedisçš„æ•°æ®ç»“æ„ã€‚Rediså¼€å‘è€…å¯ä»¥åˆ›å»ºåŒRedisåŸç”Ÿå‘½ä»¤ä¸€æ ·çš„å¼ºå¤§ä¸”é«˜æ€§èƒ½çš„å‘½ä»¤ã€‚</li>
<li>å¦ä¸€ç§APIé«˜çº§APIå¯ä»¥è°ƒç”¨Rediså‘½ä»¤å¹¶ä¸”è·å–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°±å¦‚åŒLuaè„šæœ¬è®¿é—®Redisä¸€æ ·ã€‚</li>
</ul>
<h4 id="å¼€å‘è‡ªå·±çš„æ¨¡å—"><a href="#å¼€å‘è‡ªå·±çš„æ¨¡å—" class="headerlink" title="å¼€å‘è‡ªå·±çš„æ¨¡å—"></a>å¼€å‘è‡ªå·±çš„æ¨¡å—</h4><p>å¼€å‘ä¸€ä¸ªæ¨¡å—æœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯ä»Redisçš„<a href="https://github.com/antirez/redis/blob/5.0/src/redismodule.h" target="_blank" rel="noopener">å®˜æ–¹ä»“åº“</a>ä¸‹è½½<code>redismodule.h</code>æ–‡ä»¶ï¼Œç„¶åæ‹·è´åˆ°è‡ªå·±çš„é¡¹ç›®é‡Œé¢å»ã€‚å®ç°è‡ªå·±çš„æ¨¡å—çš„é€»è¾‘ï¼Œé“¾æ¥æ‰€æœ‰ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæœ€åç”Ÿæˆä¸€ä¸ªå¯¼å‡ºäº†<code>RedisModule_OnLoad()</code>æ–¹æ³•çš„åŠ¨æ€é“¾æ¥åº“ã€‚</p>
<p>æˆ‘ä»¬è¿™æ¬¡è¦ç”¨Cè¯­è¨€å¼€å‘ä¸€ä¸ªæ‰©å±•æ¨¡å—ï¼š<code>LIST_EXTEND</code>ï¼Œè¿™ä¸ªæ¨¡å—æœ‰ä¸ªå‘½ä»¤<code>FILTER</code>ã€‚<br>è°ƒç”¨æ–¹å¼å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIST_EXTEND.FILTER SOURCE_LIST DEST_LIST LOW_VALUE HIGH_VALUE</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‘½ä»¤ä¼šå»è¯»å–æŒ‡å®š(<code>list</code>ç±»å‹çš„)<code>SOURCE_LIST</code>çš„æ•°æ®ï¼Œç„¶åæŒ‰ç…§ä¸‹é¢çš„è§„åˆ™è¿›è¡Œè¿‡æ»¤ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOW_VALUE &lt;= ELEMENT VALUE &lt;= HIGH_VALUE</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨åˆ™å…ˆåˆ é™¤ï¼‰ï¼Œè¿‡æ»¤ä¹‹åçš„æ•°æ®è®¾ç½®ä¸ºä¸ºè¿™ä¸ªæ–°çš„åˆ—è¡¨çš„æ•°æ®ã€‚</p>
<p>å¦‚æœ<code>LOW_VALUE &gt; MAX_VALUE</code>,ç»“æœå°±æ˜¯ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚</p>
<p>å…¶ä¸­<code>LOW_VALUE</code>å’Œ<code>MAX_VALUE</code>å¯ä»¥æ˜¯å­—ç¬¦ä¸²<code>-inf</code>å’Œ<code>+inf</code>è¡¨ç¤ºä¸é™åˆ¶æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚</p>
<p>è¿™ä¸ªå‘½ä»¤ä¼šè¿”å›æ–°åˆ—è¡¨å…ƒç´ çš„ä¸ªæ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; module load /Users/slogen/Documents/code/slogen/module/module.o</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; LPUSH source_list 20 2 30 1 40</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; LIST_EXTEND.FILTER source_list destination_list 2 20</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; LRANGE destination_list 0 -1</span><br><span class="line">1) &quot;2&quot;</span><br><span class="line">2) &quot;20&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆä¸‹è½½<code>redismodule.h</code>æ–‡ä»¶æ”¾åˆ°è‡ªå·±çš„é¡¹ç›®ç›®å½•ï¼Œç„¶åæ–°å»ºä¸€ä¸ª<code>.c</code>æ–‡ä»¶:<code>mymodule.c</code>(æ–‡ä»¶åéšæ„)ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//</span><br><span class="line">// Created by Slogen on 2019/10/16.</span><br><span class="line">//</span><br><span class="line">#include &quot;redismodule.h&quot;</span><br><span class="line">#include &lt;limits.h&gt;</span><br><span class="line"></span><br><span class="line">// æ£€æŸ¥ç»™å®šçš„å‚æ•°æ˜¯å¦è¶…è¿‡é™åˆ¶</span><br><span class="line">int checkLimit(RedisModuleString *argv,RedisModuleString *expect,long long *value,int dValue) &#123;</span><br><span class="line">    if(0 == RedisModule_StringCompare(argv,expect)) &#123;</span><br><span class="line">        *value = dValue;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if(REDISMODULE_OK == RedisModule_StringToLongLong(argv,value)) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int ListExtendFilter_RedisCommand(RedisModuleCtx *ctx,RedisModuleString **argv,int argc) &#123;</span><br><span class="line">    if(argc != 5) &#123;</span><br><span class="line">        return RedisModule_WrongArity(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    // è®©redisè‡ªåŠ¨ç®¡ç†å†…å­˜</span><br><span class="line">    RedisModule_AutoMemory(ctx);</span><br><span class="line">    // æ‰“å¼€æºæ•°æ®key</span><br><span class="line">    RedisModuleKey *sourceListkey = (RedisModuleKey *)RedisModule_OpenKey(ctx,argv[1],REDISMODULE_WRITE | REDISMODULE_READ);</span><br><span class="line">    int sourceListKeyType = RedisModule_KeyType(sourceListkey);</span><br><span class="line">    if(REDISMODULE_KEYTYPE_LIST != sourceListKeyType &amp;&amp; REDISMODULE_KEYTYPE_EMPTY != sourceListKeyType) &#123;</span><br><span class="line">        RedisModule_CloseKey(sourceListkey);</span><br><span class="line">        return RedisModule_ReplyWithError(ctx,REDISMODULE_ERRORMSG_WRONGTYPE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ‰“å¼€ç›®æ ‡key</span><br><span class="line">    RedisModuleKey *destinationListKey = (RedisModuleKey *)RedisModule_OpenKey(ctx,argv[2],REDISMODULE_WRITE);</span><br><span class="line">    RedisModule_DeleteKey(destinationListKey);</span><br><span class="line"></span><br><span class="line">    // è·å–æºæ•°æ®åˆ—è¡¨çš„é•¿åº¦</span><br><span class="line">    size_t sourceListLentth = RedisModule_ValueLength(sourceListkey);</span><br><span class="line">    if(0 == sourceListLentth) &#123;</span><br><span class="line">        RedisModule_ReplyWithLongLong(ctx,0L);</span><br><span class="line">        return REDISMODULE_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char strLowerLimit[] = &quot;-inf&quot;;</span><br><span class="line">    char strUpperLimit[] = &quot;+inf&quot;;</span><br><span class="line">    RedisModuleString *expectedMinusInf,*expectedPlusInf;</span><br><span class="line"></span><br><span class="line">    long long lowerLimit;</span><br><span class="line">    long long upperLimit;</span><br><span class="line">    int lowerLimitOk = 0;</span><br><span class="line">    int upperLimitOk = 0;</span><br><span class="line"></span><br><span class="line">    expectedMinusInf = RedisModule_CreateString(ctx,strLowerLimit,4);</span><br><span class="line">    expectedPlusInf = RedisModule_CreateString(ctx,strUpperLimit,4);</span><br><span class="line"></span><br><span class="line">    lowerLimitOk = checkLimit(argv[3],expectedMinusInf,&amp;lowerLimit,LONG_MIN);</span><br><span class="line">    upperLimitOk = checkLimit(argv[4],expectedPlusInf,&amp;upperLimit,LONG_MAX);</span><br><span class="line"></span><br><span class="line">    // the number of added elements to the destination_list</span><br><span class="line">    size_t added = 0;</span><br><span class="line">    for(size_t pos = 0;pos &lt; sourceListLentth;++pos) &#123;</span><br><span class="line">        RedisModuleString *ele = RedisModule_ListPop(sourceListkey,REDISMODULE_LIST_TAIL);</span><br><span class="line">        RedisModule_ListPush(sourceListkey,REDISMODULE_LIST_HEAD,ele);</span><br><span class="line">        long long val;</span><br><span class="line">        if(REDISMODULE_OK == RedisModule_StringToLongLong(ele,&amp;val) &amp;&amp; 1 == lowerLimitOk &amp;&amp; 1 == upperLimitOk) &#123;</span><br><span class="line">            if(val &gt;= lowerLimit &amp;&amp; val &lt;= upperLimit) &#123;</span><br><span class="line">                RedisModuleString *newele = RedisModule_CreateStringFromLongLong(ctx,val);</span><br><span class="line"></span><br><span class="line">                // push to destination_list</span><br><span class="line">                if(REDISMODULE_ERR == RedisModule_ListPush(destinationListKey,REDISMODULE_LIST_HEAD,newele)) &#123;</span><br><span class="line">                    return REDISMODULE_ERR;</span><br><span class="line">                &#125;</span><br><span class="line">                added++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    RedisModule_ReplyWithLongLong(ctx,added);</span><br><span class="line">    RedisModule_ReplicateVerbatim(ctx);</span><br><span class="line">    return REDISMODULE_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Redis æ¨¡å—çš„å…¥å£å‡½æ•°</span><br><span class="line">int RedisModule_OnLoad(RedisModuleCtx *ctx,RedisModuleString **argv,int argc) &#123;</span><br><span class="line">    if(REDISMODULE_ERR == RedisModule_Init(ctx,&quot;list_extend&quot;,1,REDISMODULE_APIVER_1)) &#123;</span><br><span class="line">        return REDISMODULE_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    if(REDISMODULE_ERR == RedisModule_CreateCommand(ctx,&quot;list_extend.filter&quot;,ListExtendFilter_RedisCommand,&quot;write deny-oom&quot;,1,1,1)) &#123;</span><br><span class="line">        return REDISMODULE_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    return REDISMODULE_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¨¡å—å¼€å‘å®Œæ¯•ä¹‹åï¼Œéœ€è¦ç¼–è¯‘ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared -std=gnu99 -o module.o module.c</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ<code>module.o</code>æ–‡ä»¶ï¼Œç„¶åè¿æ¥Redis Serverï¼Œä½¿ç”¨<code>MODULE LOAD</code>å‘½ä»¤åŠ è½½æ¨¡å—ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; module load /Users/slogen/Documents/code/slogen/module/module.o</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; LPUSH source_list 20 2 30 1 40</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; LIST_EXTEND.FILTER source_list destination_list 2 20</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; LRANGE destination_list 0 -1</span><br><span class="line">1) &quot;2&quot;</span><br><span class="line">2) &quot;20&quot;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œæ¨¡å—å·²ç»è¢«åŠ è½½åˆ°Redisç³»ç»Ÿäº†ï¼Œä½†æ˜¯æœ‰å¯èƒ½ä¼šå‡ºç°æŠ¥é”™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Module module.o does not export RedisModule_OnLoad() symbol. Module not loaded</span><br></pre></td></tr></table></figure>
<p>è€Œä¸”æ£€æŸ¥äº†ä»£ç ï¼Œçš„ç¡®å­˜åœ¨<code>RedisModule_OnLoad()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆä¸€ä¸ªå¯èƒ½çš„åŸå› æ˜¯ä»£ç æ˜¯ç”¨C++å†™çš„è€Œä¸æ˜¯C(æ‰©å±•åæ˜¯.cppè€Œä¸æ˜¯.c)ã€‚</p>
<p>C++ç¼–è¯‘å™¨åœ¨å¯¹æºç è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ä¼šåšåå­—è½¬æ¢ï¼Œæ‰€ä»¥æºç ä¸­çš„<code>RedisModule_OnLoad</code>æ–¹æ³•åä¼šè¢«è½¬æ¢æˆå…¶ä»–çš„åå­—ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  module nm module.o | grep OnLoad</span><br><span class="line">0000000000001520 T __Z18RedisModule_OnLoadP14RedisModuleCtxPP17RedisModuleStringi</span><br></pre></td></tr></table></figure>
<h4 id="æ¨¡å—åŸç†åˆ†æ"><a href="#æ¨¡å—åŸç†åˆ†æ" class="headerlink" title="æ¨¡å—åŸç†åˆ†æ"></a>æ¨¡å—åŸç†åˆ†æ</h4><p>Redisæ¨¡å—çš„å…¥å£ç‚¹åœ¨äº<code>RedisModule_OnLoad()</code>æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œå¯ä»¥å¯¹æ¨¡å—è¿›è¡Œåˆå§‹åŒ–ï¼Œæ³¨å†Œæ¨¡å—å‘½ä»¤ä»¥åŠæ¨¡å—ä¸­å¯èƒ½ä¼šç”¨åˆ°çš„æ•°æ®ç»“æ„ã€‚</p>
<p>ç°åœ¨æ¥çœ‹ä¸‹<code>RedisModule_OnLoad()</code>æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int RedisModule_OnLoad(RedisModuleCtx *ctx,RedisModuleString **argv,int argc) &#123;</span><br><span class="line">    // 1. åˆå§‹åŒ–æ¨¡å—å±æ€§</span><br><span class="line">    if(REDISMODULE_ERR == RedisModule_Init(ctx,&quot;list_extend&quot;,1,REDISMODULE_APIVER_1)) &#123;</span><br><span class="line">        return REDISMODULE_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    // 2. æ³¨å†Œæ¨¡å—å‘½ä»¤ã€‚</span><br><span class="line">    // &quot;write&quot;: æ¨¡å—å‘½ä»¤å¯èƒ½ä¼šä¿®æ”¹æ•°æ®ï¼Œä¹Ÿä¼šè¯»å–æ•°æ®</span><br><span class="line">    // &quot;deny-oom&quot;: å‘½ä»¤ä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨é¢å¤–çš„å†…å­˜ï¼Œå› æ­¤éœ€è¦é¢„é˜²å‡ºç°oomçš„æƒ…å†µ</span><br><span class="line">    if(REDISMODULE_ERR == RedisModule_CreateCommand(ctx,&quot;list_extend.filter&quot;,ListExtendFilter_RedisCommand,&quot;write deny-oom&quot;,1,1,1)) &#123;</span><br><span class="line">        return REDISMODULE_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    return REDISMODULE_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>RedisModule_OnLoad()</code>æ–¹æ³•ä¸­é¦–å…ˆè¦è°ƒç”¨<code>RedisModule_Init()</code>æ–¹æ³•æ–¹æ³•ã€‚</p>
<p><code>RedisModule_Init()</code>æ–¹æ³•çš„åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static int RedisModule_Init(RedisModuleCtx *ctx, const char *name, int ver, int apiver);</span><br></pre></td></tr></table></figure>
<p><code>RedisModule_Init()</code>æ–¹æ³•ä¼šå‘Redisæ¨¡å—ç³»ç»Ÿæ³¨å†Œè¯¥æ¨¡å—çš„åç§°ã€ç‰ˆæœ¬ä»¥åŠè‡ªå·±éœ€è¦çš„APIçš„ç‰ˆæœ¬ã€‚</p>
<p>åœ¨<code>RedisModule_Init()</code>æ–¹æ³•ä¸­ä¼šå®ŒæˆRedisæ¨¡å—ç³»ç»Ÿå¯¹å¤–æš´éœ²çš„APIçš„æ³¨å†Œï¼Œè¿™ä¸ªåé¢ä¼šè®²ã€‚</p>
<p>æ¥ä¸‹æ¥éœ€è¦è°ƒç”¨<code>RedisModule_CreateCommand()</code>æ–¹æ³•æ¥æ³¨å†Œæ¨¡å—çš„å‘½ä»¤ï¼Œè¯¥æ–¹æ³•åŸå‹å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int RedisModule_CreateCommand(RedisModuleCtx *ctx, const char *name, RedisModuleCmdFunc cmdfunc, const char *strflags, int firstkey, int lastkey, int keystep);</span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å‡ ä¸ªå…³é”®çš„å‚æ•°å«ä¹‰ä¸ºï¼š</p>
<ul>
<li><code>name</code>: å‘½ä»¤çš„åç§°ã€‚</li>
<li><code>cmdfunc</code>: å‘½ä»¤çš„å®ç°ï¼Œå‡½æ•°æŒ‡é’ˆã€‚</li>
<li><code>strflags</code>: è¿™ä¸ªå‚æ•°ç”¨æ¥æ ‡è¯†æ¨¡å—å‘½ä»¤çš„å…·ä½“è¡Œä¸ºï¼Œéœ€è¦æ˜¯ä¸€ä¸ªç©ºæ ¼åˆ†éš”çš„Cé£æ ¼çš„å­—ç¬¦ä¸²ã€‚æœ¬æ¬¡å¼€å‘çš„æ¨¡å—ä¼ å…¥çš„æ˜¯â€write deny-oomâ€(å…¶ä»–çš„ä¸€äº›å±æ€§åé¢å†è¯´)ã€‚<ul>
<li><code>write</code>: è¡¨ç¤ºæ¨¡å—ä¼šä¿®æ”¹æ•°æ®(ä¹Ÿä¼šè¯»å–æ•°æ®)ã€‚</li>
<li><code>deny-oom</code>: è¡¨ç¤ºå‘½ä»¤éœ€è¦é¢å¤–çš„å†…å­˜ï¼Œä¸ºäº†é¢„é˜²å‡ºç°OOMçš„æƒ…å†µï¼Œåœ¨å†…å­˜ä¸å¤Ÿçš„æƒ…å†µä¸‹æ‹’ç»æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<p>å¦‚æœæ²¡æœ‰ä»»ä½•æŠ¥é”™çš„è¯å°±è¿”å›<code>REDISMODULE_OK</code>å¸¸é‡ã€‚</p>
<p>åœ¨è°ƒç”¨<code>RedisModule_CreateCommand()</code>æ–¹æ³•çš„æ—¶å€™ä¼ å…¥äº†å‘½ä»¤å›è°ƒå¥æŸ„ï¼Œç°åœ¨æ¥çœ‹çœ‹å‘½ä»¤çš„å®ç°<code>ListExtendFilter_RedisCommand()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">int ListExtendFilter_RedisCommand(RedisModuleCtx *ctx,RedisModuleString **argv,int argc) &#123;</span><br><span class="line">    // 1. æ£€æŸ¥å‚æ•°ä¸ªæ•°æ˜¯éƒ½ç¬¦åˆè¦æ±‚</span><br><span class="line">    if(argc != 5) &#123;</span><br><span class="line">        return RedisModule_WrongArity(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    // 2. è®©redisè‡ªåŠ¨ç®¡ç†å†…å­˜:æ³¨æ„ï¼šå¦‚æœéœ€è¦æ¨¡å—ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œåˆ™éœ€è¦é¦–å…ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•</span><br><span class="line">    RedisModule_AutoMemory(ctx);</span><br><span class="line">    // 3. æ‰“å¼€æºæ•°æ®key</span><br><span class="line">    RedisModuleKey *sourceListkey = (RedisModuleKey *)RedisModule_OpenKey(ctx,argv[1],REDISMODULE_WRITE | REDISMODULE_READ);</span><br><span class="line">    // 4. è·å–æºæ•°æ®keyç±»å‹</span><br><span class="line">    int sourceListKeyType = RedisModule_KeyType(sourceListkey);</span><br><span class="line">    // 5. æ ¡éªŒç±»å‹</span><br><span class="line">    if(REDISMODULE_KEYTYPE_LIST != sourceListKeyType &amp;&amp; REDISMODULE_KEYTYPE_EMPTY != sourceListKeyType) &#123;</span><br><span class="line">        RedisModule_CloseKey(sourceListkey);</span><br><span class="line">        return RedisModule_ReplyWithError(ctx,REDISMODULE_ERRORMSG_WRONGTYPE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 6. æ‰“å¼€ç»“æœkey</span><br><span class="line">    RedisModuleKey *destinationListKey = (RedisModuleKey *)RedisModule_OpenKey(ctx,argv[2],REDISMODULE_WRITE);</span><br><span class="line">    // å¦‚æœç»“æœkeyæ˜¯å¯å†™çš„å‰å­˜åœ¨åˆ™å…ˆåˆ é™¤å¯¹åº”çš„æ•°æ®</span><br><span class="line">    RedisModule_DeleteKey(destinationListKey);</span><br><span class="line"></span><br><span class="line">    // 7. è·å–æºæ•°æ®é•¿åº¦</span><br><span class="line">    size_t sourceListLentth = RedisModule_ValueLength(sourceListkey);</span><br><span class="line">    if(0 == sourceListLentth) &#123;</span><br><span class="line">        RedisModule_ReplyWithLongLong(ctx,0L);</span><br><span class="line">        return REDISMODULE_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char strLowerLimit[] = &quot;-inf&quot;;</span><br><span class="line">    char strUpperLimit[] = &quot;+inf&quot;;</span><br><span class="line">    RedisModuleString *expectedMinusInf,*expectedPlusInf;</span><br><span class="line"></span><br><span class="line">    long long lowerLimit;</span><br><span class="line">    long long upperLimit;</span><br><span class="line">    int lowerLimitOk = 0;</span><br><span class="line">    int upperLimitOk = 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    expectedMinusInf = RedisModule_CreateString(ctx,strLowerLimit,4);</span><br><span class="line">    expectedPlusInf = RedisModule_CreateString(ctx,strUpperLimit,4);</span><br><span class="line"></span><br><span class="line">    // 8. è·å–ä¸Šä¸‹é™</span><br><span class="line">    lowerLimitOk = checkLimit(argv[3],expectedMinusInf,&amp;lowerLimit);</span><br><span class="line">    upperLimitOk = checkLimit(argv[4],expectedPlusInf,&amp;upperLimit);</span><br><span class="line"></span><br><span class="line">    // the number of added elements to the destination_list</span><br><span class="line">    size_t added = 0;</span><br><span class="line">    for(size_t pos = 0;pos &lt; sourceListLentth;++pos) &#123;</span><br><span class="line">        RedisModuleString *ele = RedisModule_ListPop(sourceListkey,REDISMODULE_LIST_TAIL);</span><br><span class="line">        RedisModule_ListPush(sourceListkey,REDISMODULE_LIST_HEAD,ele);</span><br><span class="line">        long long val;</span><br><span class="line">        if(REDISMODULE_OK == RedisModule_StringToLongLong(ele,&amp;val) &amp;&amp; 1 == lowerLimitOk &amp;&amp; 1 == upperLimitOk) &#123;</span><br><span class="line">            if(val &gt;= lowerLimit &amp;&amp; val &lt;= upperLimit) &#123;</span><br><span class="line">                // 9. å¦‚æœæ•°æ®æ»¡è¶³è¦æ±‚ï¼Œåˆ™pushè¿›ç›®æ ‡åˆ—è¡¨ä¸­</span><br><span class="line">                RedisModuleString *newele = RedisModule_CreateStringFromLongLong(ctx,val);</span><br><span class="line"></span><br><span class="line">                // push to destination_list</span><br><span class="line">                if(REDISMODULE_ERR == RedisModule_ListPush(destinationListKey,REDISMODULE_LIST_HEAD,newele)) &#123;</span><br><span class="line">                    return REDISMODULE_ERR;</span><br><span class="line">                &#125;</span><br><span class="line">                added++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    RedisModule_ReplyWithLongLong(ctx,added);</span><br><span class="line">    RedisModule_ReplicateVerbatim(ctx);</span><br><span class="line">    return REDISMODULE_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¨¡å—ä¸Šä¸‹æ–‡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‘½ä»¤çš„å…¥å‚ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºå‚æ•°çš„ä¸ªæ•°ã€‚</p>
<p>æ•´ä¸ªæ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•ï¼Œé¦–å…ˆæ˜¯æ ¡éªŒå‚æ•°ï¼Œç„¶åæ‰“å¼€æºæ•°æ®åˆ—è¡¨å’Œç›®æ ‡ï¼Œå¯¹åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œå¦‚æœç¬¦åˆçš„è¯åˆ™æŠŠå¯¹åº”çš„æ•°æ®æ”¾è¿›ç›®æ ‡åˆ—è¡¨ä¸­ï¼Œå¹¶ç»Ÿè®¡ç¬¦åˆè¦æ±‚çš„æ•°æ®çš„ä¸ªæ•°ä½œä¸ºæœ€ç»ˆçš„è¿”å›ç»“æœã€‚</p>
<p>ä½†æ˜¯æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ol>
<li><p>å†…å­˜ç®¡ç†ã€‚<br>åœ¨æ¨¡å—å¼€å‘ä¸­ï¼Œå¼€å‘è€…å¯ä»¥è‡ªå·±è¿›è¡Œå†…å­˜ç®¡ç†(è°ƒç”¨<code>RedisModule_Alloc()</code>ã€<code>RedisModule_Realloc()</code>æˆ–è€…<code>RedisModule_Calloc()</code>åˆ†é…å†…å­˜ï¼Œè°ƒç”¨<code>RedisModule_Free()</code>é‡Šæ”¾å†…å­˜)ã€‚è‡ªå·±ç®¡ç†å†…å­˜å¾ˆå®¹æ˜“é€ æˆå†…å­˜æ³„éœ²ç­‰é—®é¢˜ï¼Œå› æ­¤Redisæä¾›äº†è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œåªéœ€è¦è°ƒç”¨<code>RedisModule_AutoMemory()</code>æ–¹æ³•å³å¯ã€‚ä½†æ˜¯æœ‰ä¸€ç‚¹å¾ˆé‡è¦çš„å°±æ˜¯<strong>å¦‚æœæ¨¡å—å®ç°éœ€è¦è®©Redisè‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œåˆ™éœ€è¦åœ¨æ¨¡å—å®ç°çš„æœ€å¼€å§‹çš„åœ°æ–¹å°±è¦è°ƒç”¨<code>RedisModule_AutoMemory()</code>æ–¹æ³•</strong>ã€‚</p>
</li>
<li><p><code>RedisModule_OpenKey()</code>ã€‚<br><code>RedisModule_OpenKey()</code>æ–¹æ³•ä¼šè¿”å›ä»£è¡¨å¯¹åº”çš„<code>Redis Key</code>çš„å¥æŸ„ï¼Œå¦‚æœå¯¹åº”çš„<code>key</code>ä¸å­˜åœ¨ï¼Œä¸”ä¼ å…¥çš„æ˜¯<code>WRITTE</code>ï¼Œåˆ™ä¾ç„¶ä¼šè¿”å›å¥æŸ„ï¼Œåœ¨ä¹‹åå¯¹keyè¿›è¡Œå†™æ“ä½œæ—¶ä¼šç”Ÿæˆå¯¹åº”çš„é”®å€¼å¯¹ã€‚å¦‚æœä¼ å…¥çš„æ˜¯<code>READ</code>åˆ™ç›´æ¥è¿”å›<code>NULL</code>ï¼Œä½†æ˜¯è¿™æ ·ä¸ä¼šå½±å“åç»­çš„<code>RedisModule_CloseKey()</code>æ–¹æ³•ã€‚</p>
</li>
</ol>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p><a href="http://slogen.xyz/2019/10/20/Redis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%A8%A1%E5%9D%97%28%E4%B8%8B%29/" target="_blank" rel="noopener">Redisæºç å­¦ä¹ ä¹‹æ¨¡å—(ä¸‹)</a></p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ol>
<li><a href="https://itnext.io/redis-5-x-under-the-hood-3-writing-a-redis-module-43fa42a6367d" target="_blank" rel="noopener">Redis 5.X under the hood: 3 â€” Writing a Redis Module</a></li>
<li><a href="https://redis.io/topics/modules-intro" target="_blank" rel="noopener">Redis Modules: an introduction to the API</a></li>
<li><a href="https://redis.io/topics/modules-api-ref" target="_blank" rel="noopener">Modules API reference</a></li>
</ol>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>ä¸‡ä¸€æ‰“èµäº†å‘¢^_^</div>
  <button id="rewardButton" disable="enable" style="width: 80px;line-height: 38px;text-align: center;font-weight: bold;color: #fff;border-radius: 5px;
margin:0 20px 20px 0;position: relative;overflow: hidden;color: #8c96a0;text-shadow:1px 1px 1px #fff;border:1px solid #dce1e6;box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);background: linear-gradient(top,#f2f3f7,#e4e8ec);" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    æ‰“èµ
  </button>
  <div id="QR" style="display: none;">
    
      <div id="wechat" style="display: inline-block;width:150px;height:150px">
        <img id="wechat_qr" src="/uploads/wechatpay.jpeg" alt="Slogen WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    
    
      <div id="alipay" style="display: inline-block;width:150px;height:150px">
        <img id="alipay_qr" src="/uploads/alipay.jpeg" alt="Slogen Alipay">
        <p>Alipay</p>
      </div>
    
    
  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Redis/" rel="tag"># Redis</a>
          
            <a href="/tags/æºç /" rel="tag"># æºç </a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/02/è‡ªå·±åŠ¨æ‰‹å†™RPC/" rel="next" title="è‡ªå·±åŠ¨æ‰‹å†™RPCæ¡†æ¶">
                <i class="fa fa-chevron-left"></i> è‡ªå·±åŠ¨æ‰‹å†™RPCæ¡†æ¶
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/20/Redisæºç å­¦ä¹ ä¹‹æ¨¡å—(ä¸‹)/" rel="prev" title="Redisæ¨¡å—å­¦ä¹ (ä¸‹):Why">
                Redisæ¨¡å—å­¦ä¹ (ä¸‹):Why <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpeg" alt="Slogen">
            
              <p class="site-author-name" itemprop="name">Slogen</p>
              <p class="site-description motion-element" itemprop="description">ä¸éª„ä¸èºï¼ŒéŸ¬å…‰å…»æ™¦ã€‚è£è¾±ä¸æƒŠï¼Œåšç§¯è–„å‘ã€‚</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#What"><span class="nav-number">1.</span> <span class="nav-text">What</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How"><span class="nav-number">2.</span> <span class="nav-text">How</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#åŠ è½½æ¨¡å—"><span class="nav-number">2.1.</span> <span class="nav-text">åŠ è½½æ¨¡å—</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å¼€å‘è‡ªå·±çš„æ¨¡å—"><span class="nav-number">2.2.</span> <span class="nav-text">å¼€å‘è‡ªå·±çš„æ¨¡å—</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¨¡å—åŸç†åˆ†æ"><span class="nav-number">2.3.</span> <span class="nav-text">æ¨¡å—åŸç†åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Why"><span class="nav-number">3.</span> <span class="nav-text">Why</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-number">4.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Slogen</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Bb4EcKhqq3La7xJ59ip4Yv8W-gzGzoHsz',
        appKey: 'LpDWAjNpYUPqyA8rRfxDqfKD',
        placeholder: 'æŒ‡ç‚¹æ±Ÿå±±ï¼Œæ¿€æ‰¬æ–‡å­—',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
